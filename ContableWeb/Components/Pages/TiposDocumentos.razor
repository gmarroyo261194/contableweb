@page "/tipos-documentos"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization
@using Volo.Abp.Application.Dtos
@using Volo.Abp.AspNetCore.Components.Web
@using Volo.Abp.BlazoriseUI
@using Blazorise
@using Blazorise.DataGrid
@using ContableWeb.Permissions
@using ContableWeb.Localization
@using ContableWeb.Services.TiposDocumentos
@using ContableWeb.Services.Dtos.TiposDocumentos
@attribute [Authorize(ContableWebPermissions.TiposDocumentos.Default)]
@inherits AbpCrudPageBase<ITipoDocumentoAppService, TipoDocumentoDto, int, PagedAndSortedResultRequestDto, CreateUpdateTipoDocumentoDto>
@inject IStringLocalizer<ContableWebResource> Localizer
@inject AbpBlazorMessageLocalizerHelper<ContableWebResource> Lh

<Card>
    <CardHeader>
        <Row Class="justify-content-between">
            <Column ColumnSize="ColumnSize.IsAuto">
                <CardTitle>@Localizer["TiposDocumentos"]</CardTitle>
            </Column>
            <Column ColumnSize="ColumnSize.IsAuto">
                @if (HasCreatePermission)
                {
                    <Button Color="Color.Primary"
                            Clicked="OpenCreateModalAsync">
                        <Icon Name="IconName.Add"/>
                        @Localizer["NewTipoDocumento"]
                    </Button>
                }
                <!-- Botón para sincronizar tipos de documentos desde AFIP -->
                <Button Color="Color.Success" 
                        Clicked="SincronizarDesdeAfipAsync"
                        Class="ms-2"
                        Loading="@_sincronizando">
                    <Icon Name="IconName.Sync" />
                    @(_sincronizando ? "Sincronizando..." : "Sincronizar desde AFIP")
                </Button>
            </Column>
        </Row>
    </CardHeader>
    <CardBody>
        <DataGrid TItem="TipoDocumentoDto"
                  Data="Entities"
                  ReadData="OnDataGridReadAsync"
                  CurrentPage="CurrentPage"
                  TotalItems="TotalCount"
                  ShowPager="true"
                  PageSize="PageSize">
            <DataGridColumns>
                <DataGridEntityActionsColumn TItem="TipoDocumentoDto" @ref="@EntityActionsColumn">
                    <DisplayTemplate>
                        <EntityActions TItem="TipoDocumentoDto" EntityActionsColumn="@EntityActionsColumn">
                            <EntityAction TItem="TipoDocumentoDto"
                                          Text="@Localizer["Edit"]"
                                          Visible="HasUpdatePermission"
                                          Clicked="() => OpenEditModalAsync(context)"/>
                            <EntityAction TItem="TipoDocumentoDto"
                                          Text="@Localizer["Delete"]"
                                          Visible="HasDeletePermission"
                                          Clicked="() => DeleteEntityAsync(context)"
                                          ConfirmationMessage="()=>GetDeleteConfirmationMessage(context)"/>
                        </EntityActions>
                    </DisplayTemplate>
                </DataGridEntityActionsColumn>
                <DataGridColumn TItem="TipoDocumentoDto"
                                Field="@nameof(TipoDocumentoDto.CodigoAfip)"
                                Caption="Código AFIP"></DataGridColumn>
                <DataGridColumn TItem="TipoDocumentoDto"
                                Field="@nameof(TipoDocumentoDto.Descripcion)"
                                Caption="Descripción"></DataGridColumn>
                <DataGridColumn TItem="TipoDocumentoDto"
                                Field="@nameof(TipoDocumentoDto.FechaDesde)"
                                Caption="Fecha Desde">
                    <DisplayTemplate Context="context">
                        @(context.FechaDesde?.ToString("dd/MM/yyyy") ?? "-")
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="TipoDocumentoDto"
                                Field="@nameof(TipoDocumentoDto.FechaHasta)"
                                Caption="Fecha Hasta">
                    <DisplayTemplate Context="context">
                        @(context.FechaHasta?.ToString("dd/MM/yyyy") ?? "-")
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="TipoDocumentoDto"
                                Field="@nameof(TipoDocumentoDto.Enabled)"
                                Caption="@Localizer["Activo"]">
                    <DisplayTemplate Context="context">
                        <Switch TValue="bool" @bind-Checked="@context.Enabled" ReadOnly="true"/>
                    </DisplayTemplate>
                </DataGridColumn>
            </DataGridColumns>
        </DataGrid>
    </CardBody>
</Card>

<!-- Modal de Creación -->
<Modal @ref="@CreateModal">
    <ModalContent IsCentered="true">
        <Form>
            <ModalHeader>
                <ModalTitle>@Localizer["NewTipoDocumento"]</ModalTitle>
                <CloseButton Clicked="CloseCreateModalAsync"/>
            </ModalHeader>
            <ModalBody>
                <Validations @ref="@CreateValidationsRef" Model="@NewEntity" ValidateOnLoad="false">
                    <Validation MessageLocalizer="@Lh.Localize">
                        <Field>
                            <FieldLabel>Código AFIP</FieldLabel>
                            <NumericEdit TValue="int" @bind-Value="@NewEntity.CodigoAfip">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </NumericEdit>
                        </Field>
                        <Field>
                            <FieldLabel>Descripción</FieldLabel>
                            <TextEdit @bind-Text="@NewEntity.Descripcion">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </TextEdit>
                        </Field>
                        <Field>
                            <FieldLabel>Fecha Desde</FieldLabel>
                            <DateEdit TValue="DateOnly?" @bind-Date="@NewEntity.FechaDesde">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </DateEdit>
                        </Field>
                        <Field>
                            <FieldLabel>Fecha Hasta</FieldLabel>
                            <DateEdit TValue="DateOnly?" @bind-Date="@NewEntity.FechaHasta">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </DateEdit>
                        </Field>
                        <Field>
                            <FieldLabel>Activo</FieldLabel>
                            <Switch TValue="bool" @bind-Checked="@NewEntity.Enabled"></Switch>
                        </Field>
                    </Validation>
                </Validations>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary"
                        Clicked="CloseCreateModalAsync">@Localizer["Cancel"]</Button>
                <Button Color="Color.Primary"
                        Type="@ButtonType.Submit"
                        PreventDefaultOnSubmit="true"
                        Clicked="CreateEntityAsync">@Localizer["Save"]</Button>
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

<!-- Modal de Edición -->
<Modal @ref="@EditModal">
    <ModalContent IsCentered="true">
        <Form>
            <ModalHeader>
                <ModalTitle>@Localizer["Edit"]</ModalTitle>
                <CloseButton Clicked="CloseEditModalAsync"/>
            </ModalHeader>
            <ModalBody>
                <Validations @ref="@EditValidationsRef" Model="@EditingEntity" ValidateOnLoad="false">
                    <Validation MessageLocalizer="@Lh.Localize">
                        <Field>
                            <FieldLabel>Código AFIP</FieldLabel>
                            <NumericEdit TValue="int" @bind-Value="@EditingEntity.CodigoAfip">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </NumericEdit>
                        </Field>
                        <Field>
                            <FieldLabel>Descripción</FieldLabel>
                            <TextEdit @bind-Text="@EditingEntity.Descripcion">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </TextEdit>
                        </Field>
                        <Field>
                            <FieldLabel>Fecha Desde</FieldLabel>
                            <DateEdit TValue="DateOnly?" @bind-Date="@EditingEntity.FechaDesde">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </DateEdit>
                        </Field>
                        <Field>
                            <FieldLabel>Fecha Hasta</FieldLabel>
                            <DateEdit TValue="DateOnly?" @bind-Date="@EditingEntity.FechaHasta">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </DateEdit>
                        </Field>
                        <Field>
                            <FieldLabel>Activo</FieldLabel>
                            <Switch TValue="bool" @bind-Checked="@EditingEntity.Enabled"></Switch>
                        </Field>
                    </Validation>
                </Validations>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary"
                        Clicked="CloseEditModalAsync">@Localizer["Cancel"]</Button>
                <Button Color="Color.Primary"
                        Type="@ButtonType.Submit"
                        PreventDefaultOnSubmit="true"
                        Clicked="UpdateEntityAsync">@Localizer["Save"]</Button>
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

@code {
    private bool _sincronizando;

    public TiposDocumentos()
    {
        CreatePolicyName = ContableWebPermissions.TiposDocumentos.Create;
        UpdatePolicyName = ContableWebPermissions.TiposDocumentos.Edit;
        DeletePolicyName = ContableWebPermissions.TiposDocumentos.Delete;
    }

    /// <summary>
    /// Sincroniza los tipos de documentos desde AFIP
    /// </summary>
    private async Task SincronizarDesdeAfipAsync()
    {
        try
        {
            _sincronizando = true;
            StateHasChanged();

            Console.WriteLine("=== INICIANDO SINCRONIZACIÓN DE TIPOS DE DOCUMENTOS ===");
            
            var resultado = await AppService.SincronizarDesdeAfipAsync();

            if (resultado.Exitoso)
            {
                await Message.Success($"{resultado.Mensaje}");
                Console.WriteLine($"✅ {resultado.Mensaje}");
                Console.WriteLine($"   - Total obtenidos: {resultado.TotalObtenidos}");
                Console.WriteLine($"   - Insertados: {resultado.Insertados}");
                Console.WriteLine($"   - Actualizados: {resultado.Actualizados}");
                
                // Recargar la grilla
                await GetEntitiesAsync();
            }
            else
            {
                await Message.Error($"Error: {resultado.Mensaje}");
                Console.WriteLine($"❌ Error: {resultado.Mensaje}");
            }

            if (resultado.Errores.Any())
            {
                Console.WriteLine("⚠️ Errores encontrados:");
                foreach (var error in resultado.Errores)
                {
                    Console.WriteLine($"   - {error}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error en sincronización: {ex.Message}");
            await Message.Error($"Error inesperado: {ex.Message}");
        }
        finally
        {
            _sincronizando = false;
            StateHasChanged();
        }
    }
}

